<!DOCTYPE html>
<html>
<head>
  <title>Typography.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "src\\myapp\\system\\libraries\\Typography.php";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>Typography.php</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="php"><span class="hljs-meta">&lt;?php</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>CodeIgniter</p>
</div>
<div class="body">
<p>An open source application development framework for PHP</p>
<p>This content is released under the MIT License (MIT)</p>
<p>Copyright (c) 2014 - 2019, British Columbia Institute of Technology</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">defined(<span class="hljs-string">'BASEPATH'</span>) <span class="hljs-keyword">OR</span> <span class="hljs-keyword">exit</span>(<span class="hljs-string">'No direct script access allowed'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Typography Class</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CI_Typography</span> </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Block level elements that should not be wrapped inside <p> tags</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $block_elements = <span class="hljs-string">'address|blockquote|div|dl|fieldset|form|h\d|hr|noscript|object|ol|p|pre|script|table|ul'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Elements that should not have <p> and <br /> tags within them.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $skip_elements	= <span class="hljs-string">'p|pre|ol|ul|dl|object|table|h\d'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>Tags we want the parser to completely ignore when splitting the string.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $inline_elements = <span class="hljs-string">'a|abbr|acronym|b|bdo|big|br|button|cite|code|del|dfn|em|i|img|ins|input|label|map|kbd|q|samp|select|small|span|strong|sub|sup|textarea|tt|var'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>array of block level elements that require inner content to be within another block level element</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $inner_block_required = <span class="hljs-keyword">array</span>(<span class="hljs-string">'blockquote'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>the last block element parsed</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $last_block_element = <span class="hljs-string">''</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>whether or not to protect quotes within { curly braces }</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $protect_braced_quotes = <span class="hljs-keyword">FALSE</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>Auto Typography</p>
</div>
<div class="body">
<p>This function converts text, making it typographically correct:
	- Converts double spaces into paragraphs.
	- Converts single line breaks into <br /> tags
	- Converts single and double quotes into correctly facing curly quote entities.
	- Converts three dots into ellipsis.
	- Converts double dashes into em-dashes.</p>
<ul>
<li>Converts two spaces into entities</li>
</ul>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">bool</span>
<span>whether to reduce more then two consecutive newlines to two
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">auto_typography</span><span class="hljs-params">($str, $reduce_linebreaks = FALSE)</span>
	</span>{
		<span class="hljs-keyword">if</span> ($str === <span class="hljs-string">''</span>)
		{
			<span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Standardize Newlines to make matching easier</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (strpos($str, <span class="hljs-string">"\r"</span>) !== <span class="hljs-keyword">FALSE</span>)
		{
			$str = str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">"\r\n"</span>, <span class="hljs-string">"\r"</span>), <span class="hljs-string">"\n"</span>, $str);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Reduce line breaks.  If there are more than two consecutive linebreaks
we'll compress them down to a maximum of two since there's no benefit to more.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ($reduce_linebreaks === <span class="hljs-keyword">TRUE</span>)
		{
			$str = preg_replace(<span class="hljs-string">"/\n\n+/"</span>, <span class="hljs-string">"\n\n"</span>, $str);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>HTML comment tags don't conform to patterns of normal tags, so pull them out separately, only if needed</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$html_comments = <span class="hljs-keyword">array</span>();
		<span class="hljs-keyword">if</span> (strpos($str, <span class="hljs-string">'&lt;!--'</span>) !== <span class="hljs-keyword">FALSE</span> &amp;&amp; preg_match_all(<span class="hljs-string">'#(&lt;!\-\-.*?\-\-&gt;)#s'</span>, $str, $matches))
		{
			<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>, $total = count($matches[<span class="hljs-number">0</span>]); $i &lt; $total; $i++)
			{
				$html_comments[] = $matches[<span class="hljs-number">0</span>][$i];
				$str = str_replace($matches[<span class="hljs-number">0</span>][$i], <span class="hljs-string">'{@HC'</span>.$i.<span class="hljs-string">'}'</span>, $str);
			}
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>match and yank <pre> tags if they exist.  It's cheaper to do this separately since most content will
not contain <pre> tags, and it keeps the PCRE patterns below simpler and faster</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (strpos($str, <span class="hljs-string">'&lt;pre'</span>) !== <span class="hljs-keyword">FALSE</span>)
		{
			$str = preg_replace_callback(<span class="hljs-string">'#&lt;pre.*?&gt;.*?&lt;/pre&gt;#si'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">'_protect_characters'</span>), $str);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Convert quotes within tags to temporary markers.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$str = preg_replace_callback(<span class="hljs-string">'#&lt;.+?&gt;#si'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">'_protect_characters'</span>), $str);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Do the same with braces if necessary</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;protect_braced_quotes === <span class="hljs-keyword">TRUE</span>)
		{
			$str = preg_replace_callback(<span class="hljs-string">'#\{.+?\}#si'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-string">'_protect_characters'</span>), $str);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Convert &quot;ignore&quot; tags to temporary marker.  The parser splits out the string at every tag
it encounters.  Certain inline tags, like image tags, links, span tags, etc. will be
adversely affected if they are split out so we'll convert the opening bracket &lt; temporarily to: {@TAG}</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$str = preg_replace(<span class="hljs-string">'#&lt;(/*)('</span>.<span class="hljs-keyword">$this</span>-&gt;inline_elements.<span class="hljs-string">')([ &gt;])#i'</span>, <span class="hljs-string">'{@TAG}\\1\\2\\3'</span>, $str);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<div class="dox">
<div class="summary">
<p>Split the string at every tag. This expression creates an array with this prototype:</p>
</div>
<div class="body">
<p>[array]
	{
		[0] = <opening tag>
		[1] = Content...
		[2] = <closing tag>
		Etc...
	}</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">		$chunks = preg_split(<span class="hljs-string">'/(&lt;(?:[^&lt;&gt;]+(?:"[^"]*"|\'[^\']*\')?)+&gt;)/'</span>, $str, <span class="hljs-number">-1</span>, PREG_SPLIT_DELIM_CAPTURE|PREG_SPLIT_NO_EMPTY);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Build our finalized string.  We cycle through the array, skipping tags, and processing the contained text</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$str = <span class="hljs-string">''</span>;
		$process = <span class="hljs-keyword">TRUE</span>;

		<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>, $c = count($chunks) - <span class="hljs-number">1</span>; $i &lt;= $c; $i++)
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Are we dealing with a tag? If so, we'll skip the processing for this cycle.
Well also set the &quot;process&quot; flag which allows us to skip <pre> tags and a few other things.</p>

        </td>
        <td class="code highlight">
          <pre class="php">			<span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'#&lt;(/*)('</span>.<span class="hljs-keyword">$this</span>-&gt;block_elements.<span class="hljs-string">').*?&gt;#'</span>, $chunks[$i], $match))
			{
				<span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'#'</span>.<span class="hljs-keyword">$this</span>-&gt;skip_elements.<span class="hljs-string">'#'</span>, $match[<span class="hljs-number">2</span>]))
				{
					$process = ($match[<span class="hljs-number">1</span>] === <span class="hljs-string">'/'</span>);
				}

				<span class="hljs-keyword">if</span> ($match[<span class="hljs-number">1</span>] === <span class="hljs-string">''</span>)
				{
					<span class="hljs-keyword">$this</span>-&gt;last_block_element = $match[<span class="hljs-number">2</span>];
				}

				$str .= $chunks[$i];
				<span class="hljs-keyword">continue</span>;
			}

			<span class="hljs-keyword">if</span> ($process === <span class="hljs-keyword">FALSE</span>)
			{
				$str .= $chunks[$i];
				<span class="hljs-keyword">continue</span>;
			}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Force a newline to make sure end tags get processed by _format_newlines()</p>

        </td>
        <td class="code highlight">
          <pre class="php">			<span class="hljs-keyword">if</span> ($i === $c)
			{
				$chunks[$i] .= <span class="hljs-string">"\n"</span>;
			}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Convert Newlines into <p> and <br /> tags</p>

        </td>
        <td class="code highlight">
          <pre class="php">			$str .= <span class="hljs-keyword">$this</span>-&gt;_format_newlines($chunks[$i]);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>No opening block level tag? Add it if needed.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ( ! preg_match(<span class="hljs-string">'/^\s*&lt;(?:'</span>.<span class="hljs-keyword">$this</span>-&gt;block_elements.<span class="hljs-string">')/i'</span>, $str))
		{
			$str = preg_replace(<span class="hljs-string">'/^(.*?)&lt;('</span>.<span class="hljs-keyword">$this</span>-&gt;block_elements.<span class="hljs-string">')/i'</span>, <span class="hljs-string">'&lt;p&gt;$1&lt;/p&gt;&lt;$2'</span>, $str);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Convert quotes, elipsis, em-dashes, non-breaking spaces, and ampersands</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$str = <span class="hljs-keyword">$this</span>-&gt;format_characters($str);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>restore HTML comments</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>, $total = count($html_comments); $i &lt; $total; $i++)
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>remove surrounding paragraph tags, but only if there's an opening paragraph tag
otherwise HTML comments at the ends of paragraphs will have the closing tag removed
if '<p>{@HC1}' then replace <p>{@HC1}</p> with the comment, else replace only {@HC1} with the comment</p>

        </td>
        <td class="code highlight">
          <pre class="php">			$str = preg_replace(<span class="hljs-string">'#(?(?=&lt;p&gt;\{@HC'</span>.$i.<span class="hljs-string">'\})&lt;p&gt;\{@HC'</span>.$i.<span class="hljs-string">'\}(\s*&lt;/p&gt;)|\{@HC'</span>.$i.<span class="hljs-string">'\})#s'</span>, $html_comments[$i], $str);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>Final clean up</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$table = <span class="hljs-keyword">array</span>(

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>If the user submitted their own paragraph tags within the text
we will retain them instead of using our tags.</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">'/(&lt;p[^&gt;*?]&gt;)&lt;p&gt;/'</span>	=&gt; <span class="hljs-string">'$1'</span>, <span class="hljs-comment">// <span class="hljs-meta">&lt;?php</span> BBEdit syntax coloring bug fix</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Reduce multiple instances of opening/closing paragraph tags to a single one</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">'#(&lt;/p&gt;)+#'</span>			=&gt; <span class="hljs-string">'&lt;/p&gt;'</span>,
						<span class="hljs-string">'/(&lt;p&gt;\W*&lt;p&gt;)+/'</span>	=&gt; <span class="hljs-string">'&lt;p&gt;'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Clean up stray paragraph tags that appear before block level elements</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">'#&lt;p&gt;&lt;/p&gt;&lt;('</span>.<span class="hljs-keyword">$this</span>-&gt;block_elements.<span class="hljs-string">')#'</span>	=&gt; <span class="hljs-string">'&lt;$1'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Clean up stray non-breaking spaces preceding block elements</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">'#(&amp;nbsp;\s*)+&lt;('</span>.<span class="hljs-keyword">$this</span>-&gt;block_elements.<span class="hljs-string">')#'</span>	=&gt; <span class="hljs-string">'  &lt;$2'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Replace the temporary markers we added earlier</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">'/\{@TAG\}/'</span>		=&gt; <span class="hljs-string">'&lt;'</span>,
						<span class="hljs-string">'/\{@DQ\}/'</span>			=&gt; <span class="hljs-string">'"'</span>,
						<span class="hljs-string">'/\{@SQ\}/'</span>			=&gt; <span class="hljs-string">"'"</span>,
						<span class="hljs-string">'/\{@DD\}/'</span>			=&gt; <span class="hljs-string">'--'</span>,
						<span class="hljs-string">'/\{@NBS\}/'</span>		=&gt; <span class="hljs-string">'  '</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>An unintended consequence of the _format_newlines function is that
some of the newlines get truncated, resulting in <p> tags
starting immediately after <block> tags on the same line.
This forces a newline after such occurrences, which looks much nicer.</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">"/&gt;&lt;p&gt;\n/"</span>			=&gt; <span class="hljs-string">"&gt;\n&lt;p&gt;"</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Similarly, there might be cases where a closing </block> will follow
a closing </p> tag, so we'll correct it by adding a newline in between</p>

        </td>
        <td class="code highlight">
          <pre class="php">						<span class="hljs-string">'#&lt;/p&gt;&lt;/#'</span>			=&gt; <span class="hljs-string">"&lt;/p&gt;\n&lt;/"</span>
						);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>Do we need to reduce empty lines?</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ($reduce_linebreaks === <span class="hljs-keyword">TRUE</span>)
		{
			$table[<span class="hljs-string">'#&lt;p&gt;\n*&lt;/p&gt;#'</span>] = <span class="hljs-string">''</span>;
		}
		<span class="hljs-keyword">else</span>
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>If we have empty paragraph tags we add a non-breaking space
otherwise most browsers won't treat them as true paragraphs</p>

        </td>
        <td class="code highlight">
          <pre class="php">			$table[<span class="hljs-string">'#&lt;p&gt;&lt;/p&gt;#'</span>] = <span class="hljs-string">'&lt;p&gt;&amp;nbsp;&lt;/p&gt;'</span>;
		}

		<span class="hljs-keyword">return</span> preg_replace(array_keys($table), $table, $str);

	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<div class="dox">
<div class="summary">
<p>Format Characters</p>
</div>
<div class="body">
<p>This function mainly converts double and single quotes
to curly entities, but it also converts em-dashes,
double spaces, and ampersands</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format_characters</span><span class="hljs-params">($str)</span>
	</span>{
		<span class="hljs-keyword">static</span> $table;

		<span class="hljs-keyword">if</span> ( ! <span class="hljs-keyword">isset</span>($table))
		{
			$table = <span class="hljs-keyword">array</span>(
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>nested smart quotes, opening and closing
note that rules for grammar (English) allow only for two levels deep
and that single quotes are <em>supposed</em> to always be on the outside
but we'll accommodate both
Note that in all cases, whitespace is the primary determining factor
on which direction to curl, with non-word characters like punctuation
being a secondary factor only after whitespace is addressed.</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">'/\'"(\s|$)/'</span>					=&gt; <span class="hljs-string">'&amp;#8217;&amp;#8221;$1'</span>,
							<span class="hljs-string">'/(^|\s|&lt;p&gt;)\'"/'</span>				=&gt; <span class="hljs-string">'$1&amp;#8216;&amp;#8220;'</span>,
							<span class="hljs-string">'/\'"(\W)/'</span>						=&gt; <span class="hljs-string">'&amp;#8217;&amp;#8221;$1'</span>,
							<span class="hljs-string">'/(\W)\'"/'</span>						=&gt; <span class="hljs-string">'$1&amp;#8216;&amp;#8220;'</span>,
							<span class="hljs-string">'/"\'(\s|$)/'</span>					=&gt; <span class="hljs-string">'&amp;#8221;&amp;#8217;$1'</span>,
							<span class="hljs-string">'/(^|\s|&lt;p&gt;)"\'/'</span>				=&gt; <span class="hljs-string">'$1&amp;#8220;&amp;#8216;'</span>,
							<span class="hljs-string">'/"\'(\W)/'</span>						=&gt; <span class="hljs-string">'&amp;#8221;&amp;#8217;$1'</span>,
							<span class="hljs-string">'/(\W)"\'/'</span>						=&gt; <span class="hljs-string">'$1&amp;#8220;&amp;#8216;'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>single quote smart quotes</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">'/\'(\s|$)/'</span>					=&gt; <span class="hljs-string">'&amp;#8217;$1'</span>,
							<span class="hljs-string">'/(^|\s|&lt;p&gt;)\'/'</span>				=&gt; <span class="hljs-string">'$1&amp;#8216;'</span>,
							<span class="hljs-string">'/\'(\W)/'</span>						=&gt; <span class="hljs-string">'&amp;#8217;$1'</span>,
							<span class="hljs-string">'/(\W)\'/'</span>						=&gt; <span class="hljs-string">'$1&amp;#8216;'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>double quote smart quotes</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">'/"(\s|$)/'</span>						=&gt; <span class="hljs-string">'&amp;#8221;$1'</span>,
							<span class="hljs-string">'/(^|\s|&lt;p&gt;)"/'</span>					=&gt; <span class="hljs-string">'$1&amp;#8220;'</span>,
							<span class="hljs-string">'/"(\W)/'</span>						=&gt; <span class="hljs-string">'&amp;#8221;$1'</span>,
							<span class="hljs-string">'/(\W)"/'</span>						=&gt; <span class="hljs-string">'$1&amp;#8220;'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>apostrophes</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">"/(\w)'(\w)/"</span>					=&gt; <span class="hljs-string">'$1&amp;#8217;$2'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>Em dash and ellipses dots</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">'/\s?\-\-\s?/'</span>					=&gt; <span class="hljs-string">'&amp;#8212;'</span>,
							<span class="hljs-string">'/(\w)\.{3}/'</span>					=&gt; <span class="hljs-string">'$1&amp;#8230;'</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>double space after sentences</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">'/(\W)  /'</span>						=&gt; <span class="hljs-string">'$1&amp;nbsp; '</span>,

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>ampersands, if not a character entity</p>

        </td>
        <td class="code highlight">
          <pre class="php">							<span class="hljs-string">'/&amp;(?!#?[a-zA-Z0-9]{2,};)/'</span>		=&gt; <span class="hljs-string">'&amp;amp;'</span>
						);
		}

		<span class="hljs-keyword">return</span> preg_replace(array_keys($table), $table, $str);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<div class="dox">
<div class="summary">
<p>Format Newlines</p>
</div>
<div class="body">
<p>Converts newline characters into either <p> tags or <br /></p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_format_newlines</span><span class="hljs-params">($str)</span>
	</span>{
		<span class="hljs-keyword">if</span> ($str === <span class="hljs-string">''</span> <span class="hljs-keyword">OR</span> (strpos($str, <span class="hljs-string">"\n"</span>) === <span class="hljs-keyword">FALSE</span> &amp;&amp; ! in_array(<span class="hljs-keyword">$this</span>-&gt;last_block_element, <span class="hljs-keyword">$this</span>-&gt;inner_block_required)))
		{
			<span class="hljs-keyword">return</span> $str;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>Convert two consecutive newlines to paragraphs</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$str = str_replace(<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"&lt;/p&gt;\n\n&lt;p&gt;"</span>, $str);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>Convert single spaces to <br /> tags</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$str = preg_replace(<span class="hljs-string">"/([^\n])(\n)([^\n])/"</span>, <span class="hljs-string">'\\1&lt;br /&gt;\\2\\3'</span>, $str);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>Wrap the whole enchilada in enclosing paragraphs</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ($str !== <span class="hljs-string">"\n"</span>)
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>We trim off the right-side new line so that the closing </p> tag
will be positioned immediately following the string, matching
the behavior of the opening <p> tag</p>

        </td>
        <td class="code highlight">
          <pre class="php">			$str =  <span class="hljs-string">'&lt;p&gt;'</span>.rtrim($str).<span class="hljs-string">'&lt;/p&gt;'</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<p>Remove empty paragraphs if they are on the first line, as this
is a potential unintended consequence of the previous code</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">return</span> preg_replace(<span class="hljs-string">'/&lt;p&gt;&lt;\/p&gt;(.*)/'</span>, <span class="hljs-string">'\\1'</span>, $str, <span class="hljs-number">1</span>);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<div class="dox">
<div class="summary">
<p>Protect Characters</p>
</div>
<div class="body">
<p>Protects special characters from being formatted later
We don't want quotes converted within tags so we'll temporarily convert them to {@DQ} and {@SQ}
and we don't want double dashes converted to emdash entities, so they are marked with {@DD}
likewise double spaces are converted to {@NBS} to prevent entity conversion</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">array</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_protect_characters</span><span class="hljs-params">($match)</span>
	</span>{
		<span class="hljs-keyword">return</span> str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">"'"</span>,<span class="hljs-string">'"'</span>,<span class="hljs-string">'--'</span>,<span class="hljs-string">'  '</span>), <span class="hljs-keyword">array</span>(<span class="hljs-string">'{@SQ}'</span>, <span class="hljs-string">'{@DQ}'</span>, <span class="hljs-string">'{@DD}'</span>, <span class="hljs-string">'{@NBS}'</span>), $match[<span class="hljs-number">0</span>]);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56"></a>
</div>
<div class="dox">
<div class="summary">
<p>Convert newlines to HTML line breaks except within PRE tags</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nl2br_except_pre</span><span class="hljs-params">($str)</span>
	</span>{
		$newstr = <span class="hljs-string">''</span>;
		<span class="hljs-keyword">for</span> ($ex = explode(<span class="hljs-string">'pre&gt;'</span>, $str), $ct = count($ex), $i = <span class="hljs-number">0</span>; $i &lt; $ct; $i++)
		{
			$newstr .= (($i % <span class="hljs-number">2</span>) === <span class="hljs-number">0</span>) ? nl2br($ex[$i]) : $ex[$i];
			<span class="hljs-keyword">if</span> ($ct - <span class="hljs-number">1</span> !== $i)
			{
				$newstr .= <span class="hljs-string">'pre&gt;'</span>;
			}
		}

		<span class="hljs-keyword">return</span> $newstr;
	}

}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
