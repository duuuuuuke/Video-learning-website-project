<!DOCTYPE html>
<html>
<head>
  <title>Zip.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "src\\myapp\\system\\libraries\\Zip.php";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>Zip.php</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="php"><span class="hljs-meta">&lt;?php</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>CodeIgniter</p>
</div>
<div class="body">
<p>An open source application development framework for PHP</p>
<p>This content is released under the MIT License (MIT)</p>
<p>Copyright (c) 2014 - 2019, British Columbia Institute of Technology</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">defined(<span class="hljs-string">'BASEPATH'</span>) <span class="hljs-keyword">OR</span> <span class="hljs-keyword">exit</span>(<span class="hljs-string">'No direct script access allowed'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Zip Compression Class</p>
</div>
<div class="body">
<p>This class is based on a library I found at Zend:
http://www.zend.com/codex.php?id=696&amp;single=1</p>
<p>The original library is a little rough around the edges so I
refactored it and added several additional methods -- Rick Ellis</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CI_Zip</span> </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Zip data in string form</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $zipdata = <span class="hljs-string">''</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Zip data for a directory in string form</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $directory = <span class="hljs-string">''</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>Number of files/folder in zip file</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $entries = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>Number of files in zip</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $file_num = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>relative offset of local header</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $offset = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>Reference to time at init</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $now;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>The level of compression</p>
</div>
<div class="body">
<p>Ranges from 0 to 9, with 9 being the highest level.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $compression_level = <span class="hljs-number">2</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>mbstring.func_overload flag</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> $func_overload;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>Initialize zip compression class</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span>
	</span>{
		<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">self</span>::$func_overload) <span class="hljs-keyword">OR</span> <span class="hljs-keyword">self</span>::$func_overload = (extension_loaded(<span class="hljs-string">'mbstring'</span>) &amp;&amp; ini_get(<span class="hljs-string">'mbstring.func_overload'</span>));

		<span class="hljs-keyword">$this</span>-&gt;now = time();
		log_message(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Zip Compression Class Initialized'</span>);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<div class="dox">
<div class="summary">
<p>Add Directory</p>
</div>
<div class="body">
<p>Lets you add a virtual directory into which you can place files.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">mixed</span>
<span>$directory the directory name. Can be string or array
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_dir</span><span class="hljs-params">($directory)</span>
	</span>{
		<span class="hljs-keyword">foreach</span> ((<span class="hljs-keyword">array</span>) $directory <span class="hljs-keyword">as</span> $dir)
		{
			<span class="hljs-keyword">if</span> ( ! preg_match(<span class="hljs-string">'|.+/$|'</span>, $dir))
			{
				$dir .= <span class="hljs-string">'/'</span>;
			}

			$dir_time = <span class="hljs-keyword">$this</span>-&gt;_get_mod_time($dir);
			<span class="hljs-keyword">$this</span>-&gt;_add_dir($dir, $dir_time[<span class="hljs-string">'file_mtime'</span>], $dir_time[<span class="hljs-string">'file_mdate'</span>]);
		}
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<div class="dox">
<div class="summary">
<p>Get file/directory modification time</p>
</div>
<div class="body">
<p>If this is a newly created file/dir, we will set the time to 'now'</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$dir path to file
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>array filemtime/filemdate
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_get_mod_time</span><span class="hljs-params">($dir)</span>
	</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>filemtime() may return false, but raises an error for non-existing files</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$date = file_exists($dir) ? getdate(filemtime($dir)) : getdate(<span class="hljs-keyword">$this</span>-&gt;now);

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(
			<span class="hljs-string">'file_mtime'</span> =&gt; ($date[<span class="hljs-string">'hours'</span>] &lt;&lt; <span class="hljs-number">11</span>) + ($date[<span class="hljs-string">'minutes'</span>] &lt;&lt; <span class="hljs-number">5</span>) + $date[<span class="hljs-string">'seconds'</span>] / <span class="hljs-number">2</span>,
			<span class="hljs-string">'file_mdate'</span> =&gt; (($date[<span class="hljs-string">'year'</span>] - <span class="hljs-number">1980</span>) &lt;&lt; <span class="hljs-number">9</span>) + ($date[<span class="hljs-string">'mon'</span>] &lt;&lt; <span class="hljs-number">5</span>) + $date[<span class="hljs-string">'mday'</span>]
		);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<div class="dox">
<div class="summary">
<p>Add Directory</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$dir the directory name
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$file_mtime
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$file_mdate
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_add_dir</span><span class="hljs-params">($dir, $file_mtime, $file_mdate)</span>
	</span>{
		$dir = str_replace(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, $dir);

		<span class="hljs-keyword">$this</span>-&gt;zipdata .=
			<span class="hljs-string">"\x50\x4b\x03\x04\x0a\x00\x00\x00\x00\x00"</span>
			.pack(<span class="hljs-string">'v'</span>, $file_mtime)
			.pack(<span class="hljs-string">'v'</span>, $file_mdate)
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// crc32</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// compressed filesize</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// uncompressed filesize</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-keyword">self</span>::strlen($dir)) <span class="hljs-comment">// length of pathname</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// extra field length</span>
			.$dir
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>below is &quot;data descriptor&quot; segment</p>

        </td>
        <td class="code highlight">
          <pre class="php">			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// crc32</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// compressed filesize</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// uncompressed filesize</span>

		<span class="hljs-keyword">$this</span>-&gt;directory .=
			<span class="hljs-string">"\x50\x4b\x01\x02\x00\x00\x0a\x00\x00\x00\x00\x00"</span>
			.pack(<span class="hljs-string">'v'</span>, $file_mtime)
			.pack(<span class="hljs-string">'v'</span>, $file_mdate)
			.pack(<span class="hljs-string">'V'</span>,<span class="hljs-number">0</span>) <span class="hljs-comment">// crc32</span>
			.pack(<span class="hljs-string">'V'</span>,<span class="hljs-number">0</span>) <span class="hljs-comment">// compressed filesize</span>
			.pack(<span class="hljs-string">'V'</span>,<span class="hljs-number">0</span>) <span class="hljs-comment">// uncompressed filesize</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-keyword">self</span>::strlen($dir)) <span class="hljs-comment">// length of pathname</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// extra field length</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// file comment length</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// disk number start</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// internal file attributes</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">16</span>) <span class="hljs-comment">// external file attributes - 'directory' bit set</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-keyword">$this</span>-&gt;offset) <span class="hljs-comment">// relative offset of local header</span>
			.$dir;

		<span class="hljs-keyword">$this</span>-&gt;offset = <span class="hljs-keyword">self</span>::strlen(<span class="hljs-keyword">$this</span>-&gt;zipdata);
		<span class="hljs-keyword">$this</span>-&gt;entries++;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<div class="dox">
<div class="summary">
<p>Add Data to Zip</p>
</div>
<div class="body">
<p>Lets you add files to the archive. If the path is included
in the filename it will be placed within a directory. Make
sure you use add_dir() first to create the folder.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">mixed</span>
<span>$filepath A single filepath or an array of file =&gt; data pairs
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$data Single file contents
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_data</span><span class="hljs-params">($filepath, $data = NULL)</span>
	</span>{
		<span class="hljs-keyword">if</span> (is_array($filepath))
		{
			<span class="hljs-keyword">foreach</span> ($filepath <span class="hljs-keyword">as</span> $path =&gt; $data)
			{
				$file_data = <span class="hljs-keyword">$this</span>-&gt;_get_mod_time($path);
				<span class="hljs-keyword">$this</span>-&gt;_add_data($path, $data, $file_data[<span class="hljs-string">'file_mtime'</span>], $file_data[<span class="hljs-string">'file_mdate'</span>]);
			}
		}
		<span class="hljs-keyword">else</span>
		{
			$file_data = <span class="hljs-keyword">$this</span>-&gt;_get_mod_time($filepath);
			<span class="hljs-keyword">$this</span>-&gt;_add_data($filepath, $data, $file_data[<span class="hljs-string">'file_mtime'</span>], $file_data[<span class="hljs-string">'file_mdate'</span>]);
		}
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<div class="dox">
<div class="summary">
<p>Add Data to Zip</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$filepath the file name/path
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$data the data to be encoded
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$file_mtime
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$file_mdate
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_add_data</span><span class="hljs-params">($filepath, $data, $file_mtime, $file_mdate)</span>
	</span>{
		$filepath = str_replace(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, $filepath);

		$uncompressed_size = <span class="hljs-keyword">self</span>::strlen($data);
		$crc32  = crc32($data);
		$gzdata = <span class="hljs-keyword">self</span>::substr(gzcompress($data, <span class="hljs-keyword">$this</span>-&gt;compression_level), <span class="hljs-number">2</span>, <span class="hljs-number">-4</span>);
		$compressed_size = <span class="hljs-keyword">self</span>::strlen($gzdata);

		<span class="hljs-keyword">$this</span>-&gt;zipdata .=
			<span class="hljs-string">"\x50\x4b\x03\x04\x14\x00\x00\x00\x08\x00"</span>
			.pack(<span class="hljs-string">'v'</span>, $file_mtime)
			.pack(<span class="hljs-string">'v'</span>, $file_mdate)
			.pack(<span class="hljs-string">'V'</span>, $crc32)
			.pack(<span class="hljs-string">'V'</span>, $compressed_size)
			.pack(<span class="hljs-string">'V'</span>, $uncompressed_size)
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-keyword">self</span>::strlen($filepath)) <span class="hljs-comment">// length of filename</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// extra field length</span>
			.$filepath
			.$gzdata; <span class="hljs-comment">// "file data" segment</span>

		<span class="hljs-keyword">$this</span>-&gt;directory .=
			<span class="hljs-string">"\x50\x4b\x01\x02\x00\x00\x14\x00\x00\x00\x08\x00"</span>
			.pack(<span class="hljs-string">'v'</span>, $file_mtime)
			.pack(<span class="hljs-string">'v'</span>, $file_mdate)
			.pack(<span class="hljs-string">'V'</span>, $crc32)
			.pack(<span class="hljs-string">'V'</span>, $compressed_size)
			.pack(<span class="hljs-string">'V'</span>, $uncompressed_size)
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-keyword">self</span>::strlen($filepath)) <span class="hljs-comment">// length of filename</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// extra field length</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// file comment length</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// disk number start</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// internal file attributes</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-number">32</span>) <span class="hljs-comment">// external file attributes - 'archive' bit set</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-keyword">$this</span>-&gt;offset) <span class="hljs-comment">// relative offset of local header</span>
			.$filepath;

		<span class="hljs-keyword">$this</span>-&gt;offset = <span class="hljs-keyword">self</span>::strlen(<span class="hljs-keyword">$this</span>-&gt;zipdata);
		<span class="hljs-keyword">$this</span>-&gt;entries++;
		<span class="hljs-keyword">$this</span>-&gt;file_num++;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<div class="dox">
<div class="summary">
<p>Read the contents of a file and add it to the zip</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$path
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">bool</span>
<span>$archive_filepath
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>bool
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_file</span><span class="hljs-params">($path, $archive_filepath = FALSE)</span>
	</span>{
		<span class="hljs-keyword">if</span> (file_exists($path) &amp;&amp; <span class="hljs-keyword">FALSE</span> !== ($data = file_get_contents($path)))
		{
			<span class="hljs-keyword">if</span> (is_string($archive_filepath))
			{
				$name = str_replace(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, $archive_filepath);
			}
			<span class="hljs-keyword">else</span>
			{
				$name = str_replace(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, $path);

				<span class="hljs-keyword">if</span> ($archive_filepath === <span class="hljs-keyword">FALSE</span>)
				{
					$name = preg_replace(<span class="hljs-string">'|.*/(.+)|'</span>, <span class="hljs-string">'\\1'</span>, $name);
				}
			}

			<span class="hljs-keyword">$this</span>-&gt;add_data($name, $data);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">TRUE</span>;
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<div class="dox">
<div class="summary">
<p>Read a directory and add it to the zip.</p>
</div>
<div class="body">
<p>This function recursively reads a folder and everything it contains (including
sub-folders) and creates a zip based on it. Whatever directory structure
is in the original file path will be recreated in the zip file.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$path path to source directory
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">bool</span>
<span>$preserve_filepath
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$root_path
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>bool
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_dir</span><span class="hljs-params">($path, $preserve_filepath = TRUE, $root_path = NULL)</span>
	</span>{
		$path = rtrim($path, <span class="hljs-string">'/\\'</span>).DIRECTORY_SEPARATOR;
		<span class="hljs-keyword">if</span> ( ! $fp = @opendir($path))
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Set the original directory root for child dir's to use as relative</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ($root_path === <span class="hljs-keyword">NULL</span>)
		{
			$root_path = str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>), DIRECTORY_SEPARATOR, dirname($path)).DIRECTORY_SEPARATOR;
		}

		<span class="hljs-keyword">while</span> (<span class="hljs-keyword">FALSE</span> !== ($file = readdir($fp)))
		{
			<span class="hljs-keyword">if</span> ($file[<span class="hljs-number">0</span>] === <span class="hljs-string">'.'</span>)
			{
				<span class="hljs-keyword">continue</span>;
			}

			<span class="hljs-keyword">if</span> (is_dir($path.$file))
			{
				<span class="hljs-keyword">$this</span>-&gt;read_dir($path.$file.DIRECTORY_SEPARATOR, $preserve_filepath, $root_path);
			}
			<span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">FALSE</span> !== ($data = file_get_contents($path.$file)))
			{
				$name = str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>), DIRECTORY_SEPARATOR, $path);
				<span class="hljs-keyword">if</span> ($preserve_filepath === <span class="hljs-keyword">FALSE</span>)
				{
					$name = str_replace($root_path, <span class="hljs-string">''</span>, $name);
				}

				<span class="hljs-keyword">$this</span>-&gt;add_data($name.$file, $data);
			}
		}

		closedir($fp);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">TRUE</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<div class="dox">
<div class="summary">
<p>Get the Zip file</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string (binary encoded)
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_zip</span><span class="hljs-params">()</span>
	</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Is there any data to return?</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;entries === <span class="hljs-number">0</span>)
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;zipdata
			.<span class="hljs-keyword">$this</span>-&gt;directory.<span class="hljs-string">"\x50\x4b\x05\x06\x00\x00\x00\x00"</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-keyword">$this</span>-&gt;entries) <span class="hljs-comment">// total # of entries "on this disk"</span>
			.pack(<span class="hljs-string">'v'</span>, <span class="hljs-keyword">$this</span>-&gt;entries) <span class="hljs-comment">// total # of entries overall</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-keyword">self</span>::strlen(<span class="hljs-keyword">$this</span>-&gt;directory)) <span class="hljs-comment">// size of central dir</span>
			.pack(<span class="hljs-string">'V'</span>, <span class="hljs-keyword">self</span>::strlen(<span class="hljs-keyword">$this</span>-&gt;zipdata)) <span class="hljs-comment">// offset to start of central dir</span>
			.<span class="hljs-string">"\x00\x00"</span>; <span class="hljs-comment">// .zip file comment length</span>
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<div class="dox">
<div class="summary">
<p>Write File to the specified directory</p>
</div>
<div class="body">
<p>Lets you write a file</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$filepath the file name
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>bool
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">archive</span><span class="hljs-params">($filepath)</span>
	</span>{
		<span class="hljs-keyword">if</span> ( ! ($fp = @fopen($filepath, <span class="hljs-string">'w+b'</span>)))
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

		flock($fp, LOCK_EX);

		<span class="hljs-keyword">for</span> ($result = $written = <span class="hljs-number">0</span>, $data = <span class="hljs-keyword">$this</span>-&gt;get_zip(), $length = <span class="hljs-keyword">self</span>::strlen($data); $written &lt; $length; $written += $result)
		{
			<span class="hljs-keyword">if</span> (($result = fwrite($fp, <span class="hljs-keyword">self</span>::substr($data, $written))) === <span class="hljs-keyword">FALSE</span>)
			{
				<span class="hljs-keyword">break</span>;
			}
		}

		flock($fp, LOCK_UN);
		fclose($fp);

		<span class="hljs-keyword">return</span> is_int($result);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<div class="dox">
<div class="summary">
<p>Download</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$filename the file name
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span><span class="hljs-params">($filename = <span class="hljs-string">'backup.zip'</span>)</span>
	</span>{
		<span class="hljs-keyword">if</span> ( ! preg_match(<span class="hljs-string">'|.+?\.zip$|'</span>, $filename))
		{
			$filename .= <span class="hljs-string">'.zip'</span>;
		}

		get_instance()-&gt;load-&gt;helper(<span class="hljs-string">'download'</span>);
		$get_zip = <span class="hljs-keyword">$this</span>-&gt;get_zip();
		$zip_content =&amp; $get_zip;

		force_download($filename, $zip_content);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<div class="dox">
<div class="summary">
<p>Initialize Data</p>
</div>
<div class="body">
<p>Lets you clear current zip data. Useful if you need to create
multiple zips with different data.</p>
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Zip
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clear_data</span><span class="hljs-params">()</span>
	</span>{
		<span class="hljs-keyword">$this</span>-&gt;zipdata = <span class="hljs-string">''</span>;
		<span class="hljs-keyword">$this</span>-&gt;directory = <span class="hljs-string">''</span>;
		<span class="hljs-keyword">$this</span>-&gt;entries = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">$this</span>-&gt;file_num = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">$this</span>-&gt;offset = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<div class="dox">
<div class="summary">
<p>Byte-safe strlen()</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$str
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>int
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strlen</span><span class="hljs-params">($str)</span>
	</span>{
		<span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>::$func_overload)
			? mb_strlen($str, <span class="hljs-string">'8bit'</span>)
			: strlen($str);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<div class="dox">
<div class="summary">
<p>Byte-safe substr()</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$str
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$start
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$length
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">substr</span><span class="hljs-params">($str, $start, $length = NULL)</span>
	</span>{
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>::$func_overload)
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>mb_substr($str, $start, null, '8bit') returns an empty
string on PHP 5.3</p>

        </td>
        <td class="code highlight">
          <pre class="php">			<span class="hljs-keyword">isset</span>($length) <span class="hljs-keyword">OR</span> $length = ($start &gt;= <span class="hljs-number">0</span> ? <span class="hljs-keyword">self</span>::strlen($str) - $start : -$start);
			<span class="hljs-keyword">return</span> mb_substr($str, $start, $length, <span class="hljs-string">'8bit'</span>);
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>($length)
			? substr($str, $start, $length)
			: substr($str, $start);
	}
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
