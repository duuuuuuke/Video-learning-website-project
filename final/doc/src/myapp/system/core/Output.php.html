<!DOCTYPE html>
<html>
<head>
  <title>Output.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "src\\myapp\\system\\core\\Output.php";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>Output.php</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="php"><span class="hljs-meta">&lt;?php</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>CodeIgniter</p>
</div>
<div class="body">
<p>An open source application development framework for PHP</p>
<p>This content is released under the MIT License (MIT)</p>
<p>Copyright (c) 2014 - 2019, British Columbia Institute of Technology</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">defined(<span class="hljs-string">'BASEPATH'</span>) <span class="hljs-keyword">OR</span> <span class="hljs-keyword">exit</span>(<span class="hljs-string">'No direct script access allowed'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Output Class</p>
</div>
<div class="body">
<p>Responsible for sending final output to the browser.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CI_Output</span> </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Final output string</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $final_output;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Cache expiration time</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $cache_expiration = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>List of server headers</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $headers = <span class="hljs-keyword">array</span>();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>List of mime types</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $mimes =	<span class="hljs-keyword">array</span>();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>Mime-type for the current page</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> $mime_type = <span class="hljs-string">'text/html'</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>Enable Profiler flag</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $enable_profiler = <span class="hljs-keyword">FALSE</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>php.ini zlib.output_compression flag</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> $_zlib_oc = <span class="hljs-keyword">FALSE</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>CI output compression flag</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> $_compress_output = <span class="hljs-keyword">FALSE</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>List of profiler sections</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> $_profiler_sections =	<span class="hljs-keyword">array</span>();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<div class="dox">
<div class="summary">
<p>Parse markers flag</p>
</div>
<div class="body">
<p>Whether or not to parse variables like {elapsed_time} and {memory_usage}.</p>
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> $parse_exec_vars = <span class="hljs-keyword">TRUE</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<div class="dox">
<div class="summary">
<p>mbstring.func_overload flag</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> $func_overload;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<div class="dox">
<div class="summary">
<p>Class constructor</p>
</div>
<div class="body">
<p>Determines whether zLib output compression will be used.</p>
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span>
	</span>{
		<span class="hljs-keyword">$this</span>-&gt;_zlib_oc = (bool) ini_get(<span class="hljs-string">'zlib.output_compression'</span>);
		<span class="hljs-keyword">$this</span>-&gt;_compress_output = (
			<span class="hljs-keyword">$this</span>-&gt;_zlib_oc === <span class="hljs-keyword">FALSE</span>
			&amp;&amp; config_item(<span class="hljs-string">'compress_output'</span>) === <span class="hljs-keyword">TRUE</span>
			&amp;&amp; extension_loaded(<span class="hljs-string">'zlib'</span>)
		);

		<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">self</span>::$func_overload) <span class="hljs-keyword">OR</span> <span class="hljs-keyword">self</span>::$func_overload = (extension_loaded(<span class="hljs-string">'mbstring'</span>) &amp;&amp; ini_get(<span class="hljs-string">'mbstring.func_overload'</span>));

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Get mime types for later</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">$this</span>-&gt;mimes =&amp; get_mimes();

		log_message(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Output Class Initialized'</span>);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<div class="dox">
<div class="summary">
<p>Get Output</p>
</div>
<div class="body">
<p>Returns the current output string.</p>
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_output</span><span class="hljs-params">()</span>
	</span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;final_output;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set Output</p>
</div>
<div class="body">
<p>Sets the output string.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$output Output data
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_output</span><span class="hljs-params">($output)</span>
	</span>{
		<span class="hljs-keyword">$this</span>-&gt;final_output = $output;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<div class="dox">
<div class="summary">
<p>Append Output</p>
</div>
<div class="body">
<p>Appends data onto the output string.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$output Data to append
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append_output</span><span class="hljs-params">($output)</span>
	</span>{
		<span class="hljs-keyword">$this</span>-&gt;final_output .= $output;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set Header</p>
</div>
<div class="body">
<p>Lets you set a server header which will be sent with the final output.</p>
<p>Note: If a file is cached, headers will not be sent.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$header Header
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">bool</span>
<span>$replace Whether to replace the old header value, if already set
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_header</span><span class="hljs-params">($header, $replace = TRUE)</span>
	</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>If zlib.output_compression is enabled it will compress the output,
but it will not modify the content-length header to compensate for
the reduction, causing the browser to hang waiting for more data.
We'll just skip content-length in those cases.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;_zlib_oc &amp;&amp; strncasecmp($header, <span class="hljs-string">'content-length'</span>, <span class="hljs-number">14</span>) === <span class="hljs-number">0</span>)
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
		}

		<span class="hljs-keyword">$this</span>-&gt;headers[] = <span class="hljs-keyword">array</span>($header, $replace);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set Content-Type Header</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$mime_type Extension of the file we're outputting
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$charset Character set (default: NULL)
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_content_type</span><span class="hljs-params">($mime_type, $charset = NULL)</span>
	</span>{
		<span class="hljs-keyword">if</span> (strpos($mime_type, <span class="hljs-string">'/'</span>) === <span class="hljs-keyword">FALSE</span>)
		{
			$extension = ltrim($mime_type, <span class="hljs-string">'.'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Is this extension supported?</p>

        </td>
        <td class="code highlight">
          <pre class="php">			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;mimes[$extension]))
			{
				$mime_type =&amp; <span class="hljs-keyword">$this</span>-&gt;mimes[$extension];

				<span class="hljs-keyword">if</span> (is_array($mime_type))
				{
					$mime_type = current($mime_type);
				}
			}
		}

		<span class="hljs-keyword">$this</span>-&gt;mime_type = $mime_type;

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($charset))
		{
			$charset = config_item(<span class="hljs-string">'charset'</span>);
		}

		$header = <span class="hljs-string">'Content-Type: '</span>.$mime_type
			.(<span class="hljs-keyword">empty</span>($charset) ? <span class="hljs-string">''</span> : <span class="hljs-string">'; charset='</span>.$charset);

		<span class="hljs-keyword">$this</span>-&gt;headers[] = <span class="hljs-keyword">array</span>($header, <span class="hljs-keyword">TRUE</span>);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<div class="dox">
<div class="summary">
<p>Get Current Content-Type Header</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string 'text/html', if not already set
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_content_type</span><span class="hljs-params">()</span>
	</span>{
		<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>, $c = count(<span class="hljs-keyword">$this</span>-&gt;headers); $i &lt; $c; $i++)
		{
			<span class="hljs-keyword">if</span> (sscanf(<span class="hljs-keyword">$this</span>-&gt;headers[$i][<span class="hljs-number">0</span>], <span class="hljs-string">'Content-Type: %[^;]'</span>, $content_type) === <span class="hljs-number">1</span>)
			{
				<span class="hljs-keyword">return</span> $content_type;
			}
		}

		<span class="hljs-keyword">return</span> <span class="hljs-string">'text/html'</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<div class="dox">
<div class="summary">
<p>Get Header</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$header
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_header</span><span class="hljs-params">($header)</span>
	</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Combine headers already sent with our batched headers</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$headers = array_merge(
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>We only need [x][0] from our multi-dimensional array</p>

        </td>
        <td class="code highlight">
          <pre class="php">			array_map(<span class="hljs-string">'array_shift'</span>, <span class="hljs-keyword">$this</span>-&gt;headers),
			headers_list()
		);

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($headers) <span class="hljs-keyword">OR</span> <span class="hljs-keyword">empty</span>($header))
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">NULL</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>Count backwards, in order to get the last matching header</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">for</span> ($c = count($headers) - <span class="hljs-number">1</span>; $c &gt; <span class="hljs-number">-1</span>; $c--)
		{
			<span class="hljs-keyword">if</span> (strncasecmp($header, $headers[$c], $l = <span class="hljs-keyword">self</span>::strlen($header)) === <span class="hljs-number">0</span>)
			{
				<span class="hljs-keyword">return</span> trim(<span class="hljs-keyword">self</span>::substr($headers[$c], $l+<span class="hljs-number">1</span>));
			}
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">NULL</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set HTTP Status Header</p>
</div>
<div class="body">
<p>As of version 1.7.2, this is an alias for common function
set_status_header().</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$code Status code (default: 200)
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$text Optional message
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_status_header</span><span class="hljs-params">($code = <span class="hljs-number">200</span>, $text = <span class="hljs-string">''</span>)</span>
	</span>{
		set_status_header($code, $text);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<div class="dox">
<div class="summary">
<p>Enable/disable Profiler</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">bool</span>
<span>$val TRUE to enable or FALSE to disable
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enable_profiler</span><span class="hljs-params">($val = TRUE)</span>
	</span>{
		<span class="hljs-keyword">$this</span>-&gt;enable_profiler = is_bool($val) ? $val : <span class="hljs-keyword">TRUE</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set Profiler Sections</p>
</div>
<div class="body">
<p>Allows override of default/config settings for
Profiler section display.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">array</span>
<span>$sections Profiler sections
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_profiler_sections</span><span class="hljs-params">($sections)</span>
	</span>{
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($sections[<span class="hljs-string">'query_toggle_count'</span>]))
		{
			<span class="hljs-keyword">$this</span>-&gt;_profiler_sections[<span class="hljs-string">'query_toggle_count'</span>] = (int) $sections[<span class="hljs-string">'query_toggle_count'</span>];
			<span class="hljs-keyword">unset</span>($sections[<span class="hljs-string">'query_toggle_count'</span>]);
		}

		<span class="hljs-keyword">foreach</span> ($sections <span class="hljs-keyword">as</span> $section =&gt; $enable)
		{
			<span class="hljs-keyword">$this</span>-&gt;_profiler_sections[$section] = ($enable !== <span class="hljs-keyword">FALSE</span>);
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set Cache</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$time Cache expiration time in minutes
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>CI_Output
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cache</span><span class="hljs-params">($time)</span>
	</span>{
		<span class="hljs-keyword">$this</span>-&gt;cache_expiration = is_numeric($time) ? $time : <span class="hljs-number">0</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<div class="dox">
<div class="summary">
<p>Display Output</p>
</div>
<div class="body">
<p>Processes and sends finalized output data to the browser along
with any server headers and profile data. It also stops benchmark
timers so the page rendering speed and memory usage can be shown.</p>
<p>Note: All &quot;view&quot; data is automatically put into $this-&gt;final_output
	 by controller class.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$output Output data override
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_display</span><span class="hljs-params">($output = <span class="hljs-string">''</span>)</span>
	</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>Note:  We use load_class() because we can't use $CI =&amp; get_instance()
since this function is sometimes called by the caching mechanism,
which happens before the CI super object is available.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$BM =&amp; load_class(<span class="hljs-string">'Benchmark'</span>, <span class="hljs-string">'core'</span>);
		$CFG =&amp; load_class(<span class="hljs-string">'Config'</span>, <span class="hljs-string">'core'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>Grab the super object if we can.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (class_exists(<span class="hljs-string">'CI_Controller'</span>, <span class="hljs-keyword">FALSE</span>))
		{
			$CI =&amp; get_instance();
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>Set the output data</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ($output === <span class="hljs-string">''</span>)
		{
			$output =&amp; <span class="hljs-keyword">$this</span>-&gt;final_output;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>Do we need to write a cache file? Only if the controller does not have its
own _output() method and we are not dealing with a cache file, which we
can determine by the existence of the $CI object above</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;cache_expiration &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">isset</span>($CI) &amp;&amp; ! method_exists($CI, <span class="hljs-string">'_output'</span>))
		{
			<span class="hljs-keyword">$this</span>-&gt;_write_cache($output);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>Parse out the elapsed time and memory usage,
then swap the pseudo-variables with the data</p>

        </td>
        <td class="code highlight">
          <pre class="php">
		$elapsed = $BM-&gt;elapsed_time(<span class="hljs-string">'total_execution_time_start'</span>, <span class="hljs-string">'total_execution_time_end'</span>);

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;parse_exec_vars === <span class="hljs-keyword">TRUE</span>)
		{
			$memory	= round(memory_get_usage() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>).<span class="hljs-string">'MB'</span>;
			$output = str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">'{elapsed_time}'</span>, <span class="hljs-string">'{memory_usage}'</span>), <span class="hljs-keyword">array</span>($elapsed, $memory), $output);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55"></a>
</div>
<p>Is compression requested?</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($CI) <span class="hljs-comment">// This means that we're not serving a cache file, if we were, it would already be compressed</span>
			&amp;&amp; <span class="hljs-keyword">$this</span>-&gt;_compress_output === <span class="hljs-keyword">TRUE</span>
			&amp;&amp; <span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">'HTTP_ACCEPT_ENCODING'</span>]) &amp;&amp; strpos($_SERVER[<span class="hljs-string">'HTTP_ACCEPT_ENCODING'</span>], <span class="hljs-string">'gzip'</span>) !== <span class="hljs-keyword">FALSE</span>)
		{
			ob_start(<span class="hljs-string">'ob_gzhandler'</span>);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57"></a>
</div>
<p>Are there any server headers to send?</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (count(<span class="hljs-keyword">$this</span>-&gt;headers) &gt; <span class="hljs-number">0</span>)
		{
			<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;headers <span class="hljs-keyword">as</span> $header)
			{
				@header($header[<span class="hljs-number">0</span>], $header[<span class="hljs-number">1</span>]);
			}
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59"></a>
</div>
<p>Does the $CI object exist?
If not we know we are dealing with a cache file so we'll
simply echo out the data and exit.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ( ! <span class="hljs-keyword">isset</span>($CI))
		{
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;_compress_output === <span class="hljs-keyword">TRUE</span>)
			{
				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">'HTTP_ACCEPT_ENCODING'</span>]) &amp;&amp; strpos($_SERVER[<span class="hljs-string">'HTTP_ACCEPT_ENCODING'</span>], <span class="hljs-string">'gzip'</span>) !== <span class="hljs-keyword">FALSE</span>)
				{
					header(<span class="hljs-string">'Content-Encoding: gzip'</span>);
					header(<span class="hljs-string">'Content-Length: '</span>.<span class="hljs-keyword">self</span>::strlen($output));
				}
				<span class="hljs-keyword">else</span>
				{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60"></a>
</div>
<p>User agent doesn't support gzip compression,
so we'll have to decompress our cache</p>

        </td>
        <td class="code highlight">
          <pre class="php">					$output = gzinflate(<span class="hljs-keyword">self</span>::substr($output, <span class="hljs-number">10</span>, <span class="hljs-number">-8</span>));
				}
			}

			<span class="hljs-keyword">echo</span> $output;
			log_message(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Final output sent to browser'</span>);
			log_message(<span class="hljs-string">'debug'</span>, <span class="hljs-string">'Total execution time: '</span>.$elapsed);
			<span class="hljs-keyword">return</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62"></a>
</div>
<p>Do we need to generate profile data?
If so, load the Profile class and run it.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;enable_profiler === <span class="hljs-keyword">TRUE</span>)
		{
			$CI-&gt;load-&gt;library(<span class="hljs-string">'profiler'</span>);
			<span class="hljs-keyword">if</span> ( ! <span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;_profiler_sections))
			{
				$CI-&gt;profiler-&gt;set_sections(<span class="hljs-keyword">$this</span>-&gt;_profiler_sections);
			}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63"></a>
</div>
<p>If the output data contains closing </body> and </html> tags
we will remove them and add them back after we insert the profile data</p>

        </td>
        <td class="code highlight">
          <pre class="php">			$output = preg_replace(<span class="hljs-string">'|&lt;/body&gt;.*?&lt;/html&gt;|is'</span>, <span class="hljs-string">''</span>, $output, <span class="hljs-number">-1</span>, $count).$CI-&gt;profiler-&gt;run();
			<span class="hljs-keyword">if</span> ($count &gt; <span class="hljs-number">0</span>)
			{
				$output .= <span class="hljs-string">'&lt;/body&gt;&lt;/html&gt;'</span>;
			}
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64"></a>
</div>
<p>Does the controller contain a function named _output()?
If so send the output there.  Otherwise, echo it.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (method_exists($CI, <span class="hljs-string">'_output'</span>))
		{
			$CI-&gt;_output($output);
		}
		<span class="hljs-keyword">else</span>
		{
			<span class="hljs-keyword">echo</span> $output; <span class="hljs-comment">// Send it to the browser!</span>
		}

		log_message(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Final output sent to browser'</span>);
		log_message(<span class="hljs-string">'debug'</span>, <span class="hljs-string">'Total execution time: '</span>.$elapsed);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66"></a>
</div>
<div class="dox">
<div class="summary">
<p>Write Cache</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$output Output data to cache
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_write_cache</span><span class="hljs-params">($output)</span>
	</span>{
		$CI =&amp; get_instance();
		$path = $CI-&gt;config-&gt;item(<span class="hljs-string">'cache_path'</span>);
		$cache_path = ($path === <span class="hljs-string">''</span>) ? APPPATH.<span class="hljs-string">'cache/'</span> : $path;

		<span class="hljs-keyword">if</span> ( ! is_dir($cache_path) <span class="hljs-keyword">OR</span> ! is_really_writable($cache_path))
		{
			log_message(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Unable to write cache file: '</span>.$cache_path);
			<span class="hljs-keyword">return</span>;
		}

		$uri = $CI-&gt;config-&gt;item(<span class="hljs-string">'base_url'</span>)
			.$CI-&gt;config-&gt;item(<span class="hljs-string">'index_page'</span>)
			.$CI-&gt;uri-&gt;uri_string();

		<span class="hljs-keyword">if</span> (($cache_query_string = $CI-&gt;config-&gt;item(<span class="hljs-string">'cache_query_string'</span>)) &amp;&amp; ! <span class="hljs-keyword">empty</span>($_SERVER[<span class="hljs-string">'QUERY_STRING'</span>]))
		{
			<span class="hljs-keyword">if</span> (is_array($cache_query_string))
			{
				$uri .= <span class="hljs-string">'?'</span>.http_build_query(array_intersect_key($_GET, array_flip($cache_query_string)));
			}
			<span class="hljs-keyword">else</span>
			{
				$uri .= <span class="hljs-string">'?'</span>.$_SERVER[<span class="hljs-string">'QUERY_STRING'</span>];
			}
		}

		$cache_path .= md5($uri);

		<span class="hljs-keyword">if</span> ( ! $fp = @fopen($cache_path, <span class="hljs-string">'w+b'</span>))
		{
			log_message(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Unable to write cache file: '</span>.$cache_path);
			<span class="hljs-keyword">return</span>;
		}

		<span class="hljs-keyword">if</span> ( ! flock($fp, LOCK_EX))
		{
			log_message(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Unable to secure a file lock for file at: '</span>.$cache_path);
			fclose($fp);
			<span class="hljs-keyword">return</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67"></a>
</div>
<p>If output compression is enabled, compress the cache
itself, so that we don't have to do that each time
we're serving it</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;_compress_output === <span class="hljs-keyword">TRUE</span>)
		{
			$output = gzencode($output);

			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;get_header(<span class="hljs-string">'content-type'</span>) === <span class="hljs-keyword">NULL</span>)
			{
				<span class="hljs-keyword">$this</span>-&gt;set_content_type(<span class="hljs-keyword">$this</span>-&gt;mime_type);
			}
		}

		$expire = time() + (<span class="hljs-keyword">$this</span>-&gt;cache_expiration * <span class="hljs-number">60</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68"></a>
</div>
<p>Put together our serialized info.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$cache_info = serialize(<span class="hljs-keyword">array</span>(
			<span class="hljs-string">'expire'</span>	=&gt; $expire,
			<span class="hljs-string">'headers'</span>	=&gt; <span class="hljs-keyword">$this</span>-&gt;headers
		));

		$output = $cache_info.<span class="hljs-string">'ENDCI---&gt;'</span>.$output;

		<span class="hljs-keyword">for</span> ($written = <span class="hljs-number">0</span>, $length = <span class="hljs-keyword">self</span>::strlen($output); $written &lt; $length; $written += $result)
		{
			<span class="hljs-keyword">if</span> (($result = fwrite($fp, <span class="hljs-keyword">self</span>::substr($output, $written))) === <span class="hljs-keyword">FALSE</span>)
			{
				<span class="hljs-keyword">break</span>;
			}
		}

		flock($fp, LOCK_UN);
		fclose($fp);

		<span class="hljs-keyword">if</span> ( ! is_int($result))
		{
			@unlink($cache_path);
			log_message(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Unable to write the complete cache content at: '</span>.$cache_path);
			<span class="hljs-keyword">return</span>;
		}

		chmod($cache_path, <span class="hljs-number">0640</span>);
		log_message(<span class="hljs-string">'debug'</span>, <span class="hljs-string">'Cache file written: '</span>.$cache_path);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69"></a>
</div>
<p>Send HTTP cache-control headers to browser to match file cache settings.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">$this</span>-&gt;set_cache_header($_SERVER[<span class="hljs-string">'REQUEST_TIME'</span>], $expire);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71"></a>
</div>
<div class="dox">
<div class="summary">
<p>Update/serve cached output</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">object</span>
<span>&amp;$CFG CI_Config class instance
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">object</span>
<span>&amp;$URI CI_URI class instance
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>bool TRUE on success or FALSE on failure
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_display_cache</span><span class="hljs-params">(&amp;$CFG, &amp;$URI)</span>
	</span>{
		$cache_path = ($CFG-&gt;item(<span class="hljs-string">'cache_path'</span>) === <span class="hljs-string">''</span>) ? APPPATH.<span class="hljs-string">'cache/'</span> : $CFG-&gt;item(<span class="hljs-string">'cache_path'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72"></a>
</div>
<p>Build the file path. The file name is an MD5 hash of the full URI</p>

        </td>
        <td class="code highlight">
          <pre class="php">		$uri = $CFG-&gt;item(<span class="hljs-string">'base_url'</span>).$CFG-&gt;item(<span class="hljs-string">'index_page'</span>).$URI-&gt;uri_string;

		<span class="hljs-keyword">if</span> (($cache_query_string = $CFG-&gt;item(<span class="hljs-string">'cache_query_string'</span>)) &amp;&amp; ! <span class="hljs-keyword">empty</span>($_SERVER[<span class="hljs-string">'QUERY_STRING'</span>]))
		{
			<span class="hljs-keyword">if</span> (is_array($cache_query_string))
			{
				$uri .= <span class="hljs-string">'?'</span>.http_build_query(array_intersect_key($_GET, array_flip($cache_query_string)));
			}
			<span class="hljs-keyword">else</span>
			{
				$uri .= <span class="hljs-string">'?'</span>.$_SERVER[<span class="hljs-string">'QUERY_STRING'</span>];
			}
		}

		$filepath = $cache_path.md5($uri);

		<span class="hljs-keyword">if</span> ( ! file_exists($filepath) <span class="hljs-keyword">OR</span> ! $fp = @fopen($filepath, <span class="hljs-string">'rb'</span>))
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

		flock($fp, LOCK_SH);

		$cache = (filesize($filepath) &gt; <span class="hljs-number">0</span>) ? fread($fp, filesize($filepath)) : <span class="hljs-string">''</span>;

		flock($fp, LOCK_UN);
		fclose($fp);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73"></a>
</div>
<p>Look for embedded serialized file info.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ( ! preg_match(<span class="hljs-string">'/^(.*)ENDCI---&gt;/'</span>, $cache, $match))
		{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

		$cache_info = unserialize($match[<span class="hljs-number">1</span>]);
		$expire = $cache_info[<span class="hljs-string">'expire'</span>];

		$last_modified = filemtime($filepath);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74"></a>
</div>
<p>Has the file expired?</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">if</span> ($_SERVER[<span class="hljs-string">'REQUEST_TIME'</span>] &gt;= $expire &amp;&amp; is_really_writable($cache_path))
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75"></a>
</div>
<p>If so we'll delete it.</p>

        </td>
        <td class="code highlight">
          <pre class="php">			@unlink($filepath);
			log_message(<span class="hljs-string">'debug'</span>, <span class="hljs-string">'Cache file has expired. File deleted.'</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76"></a>
</div>
<p>Send the HTTP cache control headers</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">$this</span>-&gt;set_cache_header($last_modified, $expire);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77"></a>
</div>
<p>Add headers from cache file.</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">foreach</span> ($cache_info[<span class="hljs-string">'headers'</span>] <span class="hljs-keyword">as</span> $header)
		{
			<span class="hljs-keyword">$this</span>-&gt;set_header($header[<span class="hljs-number">0</span>], $header[<span class="hljs-number">1</span>]);
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78"></a>
</div>
<p>Display the cache</p>

        </td>
        <td class="code highlight">
          <pre class="php">		<span class="hljs-keyword">$this</span>-&gt;_display(<span class="hljs-keyword">self</span>::substr($cache, <span class="hljs-keyword">self</span>::strlen($match[<span class="hljs-number">0</span>])));
		log_message(<span class="hljs-string">'debug'</span>, <span class="hljs-string">'Cache file is current. Sending it to browser.'</span>);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">TRUE</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80"></a>
</div>
<div class="dox">
<div class="summary">
<p>Delete cache</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$uri URI string
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>bool
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete_cache</span><span class="hljs-params">($uri = <span class="hljs-string">''</span>)</span>
	</span>{
		$CI =&amp; get_instance();
		$cache_path = $CI-&gt;config-&gt;item(<span class="hljs-string">'cache_path'</span>);
		<span class="hljs-keyword">if</span> ($cache_path === <span class="hljs-string">''</span>)
		{
			$cache_path = APPPATH.<span class="hljs-string">'cache/'</span>;
		}

		<span class="hljs-keyword">if</span> ( ! is_dir($cache_path))
		{
			log_message(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Unable to find cache path: '</span>.$cache_path);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($uri))
		{
			$uri = $CI-&gt;uri-&gt;uri_string();

			<span class="hljs-keyword">if</span> (($cache_query_string = $CI-&gt;config-&gt;item(<span class="hljs-string">'cache_query_string'</span>)) &amp;&amp; ! <span class="hljs-keyword">empty</span>($_SERVER[<span class="hljs-string">'QUERY_STRING'</span>]))
			{
				<span class="hljs-keyword">if</span> (is_array($cache_query_string))
				{
					$uri .= <span class="hljs-string">'?'</span>.http_build_query(array_intersect_key($_GET, array_flip($cache_query_string)));
				}
				<span class="hljs-keyword">else</span>
				{
					$uri .= <span class="hljs-string">'?'</span>.$_SERVER[<span class="hljs-string">'QUERY_STRING'</span>];
				}
			}
		}

		$cache_path .= md5($CI-&gt;config-&gt;item(<span class="hljs-string">'base_url'</span>).$CI-&gt;config-&gt;item(<span class="hljs-string">'index_page'</span>).ltrim($uri, <span class="hljs-string">'/'</span>));

		<span class="hljs-keyword">if</span> ( ! @unlink($cache_path))
		{
			log_message(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Unable to delete cache file for '</span>.$uri);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">FALSE</span>;
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">TRUE</span>;
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set Cache Header</p>
</div>
<div class="body">
<p>Set the HTTP headers to match the server-side file cache settings
in order to reduce bandwidth.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$last_modified Timestamp of when the page was last modified
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$expiration Timestamp of when should the requested page expire from cache
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>void
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_cache_header</span><span class="hljs-params">($last_modified, $expiration)</span>
	</span>{
		$max_age = $expiration - $_SERVER[<span class="hljs-string">'REQUEST_TIME'</span>];

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">'HTTP_IF_MODIFIED_SINCE'</span>]) &amp;&amp; $last_modified &lt;= strtotime($_SERVER[<span class="hljs-string">'HTTP_IF_MODIFIED_SINCE'</span>]))
		{
			<span class="hljs-keyword">$this</span>-&gt;set_status_header(<span class="hljs-number">304</span>);
			<span class="hljs-keyword">exit</span>;
		}

		header(<span class="hljs-string">'Pragma: public'</span>);
		header(<span class="hljs-string">'Cache-Control: max-age='</span>.$max_age.<span class="hljs-string">', public'</span>);
		header(<span class="hljs-string">'Expires: '</span>.gmdate(<span class="hljs-string">'D, d M Y H:i:s'</span>, $expiration).<span class="hljs-string">' GMT'</span>);
		header(<span class="hljs-string">'Last-modified: '</span>.gmdate(<span class="hljs-string">'D, d M Y H:i:s'</span>, $last_modified).<span class="hljs-string">' GMT'</span>);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84"></a>
</div>
<div class="dox">
<div class="summary">
<p>Byte-safe strlen()</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$str
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>int
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strlen</span><span class="hljs-params">($str)</span>
	</span>{
		<span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>::$func_overload)
			? mb_strlen($str, <span class="hljs-string">'8bit'</span>)
			: strlen($str);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85"></a>
</div>
<hr>

        </td>
        <td class="code highlight">
          <pre class="php">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86"></a>
</div>
<div class="dox">
<div class="summary">
<p>Byte-safe substr()</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">string</span>
<span>$str
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$start
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">int</span>
<span>$length
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>string
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="php">	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">substr</span><span class="hljs-params">($str, $start, $length = NULL)</span>
	</span>{
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>::$func_overload)
		{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87"></a>
</div>
<p>mb_substr($str, $start, null, '8bit') returns an empty
string on PHP 5.3</p>

        </td>
        <td class="code highlight">
          <pre class="php">			<span class="hljs-keyword">isset</span>($length) <span class="hljs-keyword">OR</span> $length = ($start &gt;= <span class="hljs-number">0</span> ? <span class="hljs-keyword">self</span>::strlen($str) - $start : -$start);
			<span class="hljs-keyword">return</span> mb_substr($str, $start, $length, <span class="hljs-string">'8bit'</span>);
		}

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>($length)
			? substr($str, $start, $length)
			: substr($str, $start);
	}
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
